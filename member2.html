<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì´ì§„í¬ - V8 íŒ€ì›</title>
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Dongle&family=Gowun+Dodum&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap");

      body {
        font-family: sans-serif;
      }

      /*ë©”ì¸ê³¼ ê¸€ê¼´ í†µì¼*/
      .header_section {
        background-color: #0f172a;
        font-family: "Dongle", sans-serif;
        font-style: normal;
      }
      .header_name {
        font-size: 72px;
        font-weight: bold;
        color: white;
        text-decoration: none;
        text-align: center;
        margin-left: 20px;
        margin-top: 0;
        margin-bottom: 0;
        line-height: 0.8;
      }
      /*í—¤ë” ë°°ê²½, ê¸€ê¼´ ì§€ì •*/
      .nav li {
        padding-right: 20px;
      }
      .nav-link {
        padding-left: 8px;
        padding-right: 8px;
        text-decoration: none;
        color: white;
      }
      .person-name {
        font-family: "Dongle", sans-serif;
        font-style: normal;
        font-size: 35px;
        color: gray;
        margin-top: 10px;
        line-height: 1;
      }
      /*Nav ê°„ê²©, ê¸€ì í¬ê¸° ì§€ì •*/
      .comment-top {
        display: flex;
        justify-content: space-between;
        align-items: center;

        font-weight: bold;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 8px;
      }

      .comment {
        font-weight: bold;
      }

      .person_image {
        max-width: 100%;
        height: 100%;
        border-radius: 4px;
      }
      /*imgíŒŒì¼ í¬ê¸° ì¹´ë“œì— ë§ì¶¤*/
    </style>
    <script type="module">
      // ------ Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import {
        collection,
        addDoc,
        deleteDoc,
        doc,
        query,
        orderBy,
        where,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      import { getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBUuA-bppz3--8IMOryo1p7QgOBbMfgS6s",
        authDomain: "sparta-v8.firebaseapp.com",
        projectId: "sparta-v8",
        storageBucket: "sparta-v8.firebasestorage.app",
        messagingSenderId: "641530961251",
        appId: "1:641530961251:web:25b86f361fdae002f68756",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // ----------- í† ê¸€
      // ì—´ê³  ë‹«ê¸° : ëŒ“ê¸€ ì…ë ¥ì¹¸
      $("#openclose").click(async function () {
        $("#commentbox").toggle();
        const btn = document.getElementById("openclose");
        const isVisible = $("#commentbox").is(":visible");
        btn.textContent = isVisible ? "ë‹«ê¸°" : "ëŒ“ê¸€ì‘ì„±í•˜ê¸°";
      });

      // ì—´ê³  ë‹«ê¸° : ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì¹¸ (ì‚­ì œí•˜ê¸°)
      $("#comment-area").on("click", "#delete-btn", function () {
        const parent = $(this).closest("#edit-buttons");
        const update_box = parent.find("#update-pw-box");
        const delete_box = parent.find("#delete-comment-box");

        const isVisible = delete_box.is(":visible");
        delete_box.toggle();

        // ìˆ˜ì •í•˜ê¸° ì¹¸ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        if (update_box.is(":visible")) {
          update_box.toggle();
          parent.find("#update-btn").text("ìˆ˜ì •í•˜ê¸°");
        }

        $(this).text(isVisible ? "ì‚­ì œí•˜ê¸°" : "ë‹«ê¸°");
      });

      // ì—´ê³  ë‹«ê¸° : ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì¹¸ (ìˆ˜ì •í•˜ê¸°)
      $("#comment-area").on("click", "#update-btn", function () {
        const parent = $(this).closest("#edit-buttons");
        const update_box = parent.find("#update-pw-box");
        const delete_box = parent.find("#delete-comment-box");

        const isVisible = update_box.is(":visible");
        update_box.toggle();

        // ì‚­ì œí•˜ê¸° ì¹¸ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        if (delete_box.is(":visible")) {
          delete_box.toggle();
          parent.find("#delete-btn").text("ì‚­ì œí•˜ê¸°");
        }

        $(this).text(isVisible ? "ìˆ˜ì •í•˜ê¸°" : "ë‹«ê¸°");
      });

      // ì—´ê³  ë‹«ê¸° : ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì¹¸ (ìˆ˜ì •í•˜ê¸°)
      $("#comment-area").on("click", "#close-update-btn", function () {
        const parent = $(this).closest("#update-comment-box");

        parent.toggle();
      });

      // --------- ëŒ“ê¸€ DB ì¡°ì‘
      // ëŒ“ê¸€ DB ì €ì¥
      $("#makeComment").click(async function () {
        $("#alert").empty();
        let name = $("#name").val();
        let comment = $("#comment").val();
        let password = $("#password").val();

        if (!name || !comment || !password) {
          let alert_html = `
            <div class="alert alert-warning" role="alert">
              ë‹¤ìŒ ì…ë ¥ì¹¸ë“¤ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”
            </div>`;

          $("#alert").append(alert_html);
          return;
        }

        let doc = {
          name: name,
          comment: comment,
          createdAt: Date.now(),
          password: password,
        };
        // ê°œì¸ë³„ ëŒ“ê¸€ DB
        await addDoc(collection(db, "comment2"), doc);
        alert("ì €ì¥ ì™„ë£Œ!");
        window.location.reload();
      });

      // ëŒ“ê¸€ DB ë¶ˆëŸ¬ì˜¤ê¸°
      let docs = await getDocs(
        query(collection(db, "comment2"), orderBy("createdAt", "desc"))
      );
      docs.forEach((doc) => {
        let row = doc.data();

        let name = row["name"];
        let comment = row["comment"];
        let password = row["password"];
        let createdAt = new Date(row["createdAt"]).toLocaleString();

        let temp_html = `
            <div class="border p-3 mb-2" id="high">
              <div id="hide-date" style="display: none">${row["createdAt"]}</div>
              <p class="mb-1" style="display: flex; justify-content: space-between;">
                <span><strong>ì´ë¦„:</strong> ${name}</span>
                <span style="color: gray; font-size: small;">${createdAt}</span>
              </p>
              <div class="mb-1" id="edit-buttons">
                <span><strong>ë‚´ìš©:</strong> <span style="white-space: pre-wrap;">${comment}</span></span>
                <div style="text-align: right;">
                  <button class="btn btn-outline-secondary" id="update-btn"
                    style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                    ìˆ˜ì •í•˜ê¸°
                  </button>
                  <button class="btn btn-outline-secondary" id="delete-btn"
                    style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                    ì‚­ì œí•˜ê¸°
                  </button>
                </div>
                <div class="mb-3" id="update-pw-box" style="display: none">
                  <hr/>
                  <div id="update-pw-alert"></div>
                  <p class="mb-1" style="display: flex; justify-content: space-between;">
                    <label for="exampleInputPassword1" class="form-label">Password</label>
                    <button class="btn btn-primary" id="update-pw-btn"
                      style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                      ìˆ˜ì •í•˜ê¸°
                    </button>
                  </p>
                  <input type="password" class="form-control" id="update-pw" />
                </div>

                <div id="update-comment-box" style="display: none">
                  <hr/>
                  <div id="update-comment-alert"></div>
                  <div class="mb-3">
                    <label for="commentContent" class="content">ë‚´ìš©</label>
                    <textarea
                      class="form-control"
                      id="update-comment"
                      rows="3"
                      placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    ></textarea>
                  </div>
                  <p class="mb-1" style="display: flex; justify-content: space-between;">
                    <button class="btn btn-outline-primary mb-4" id="update-comment-btn">
                      ëŒ“ê¸€ìˆ˜ì •í•˜ê¸°
                    </button>
                    <button class="btn btn-outline-primary mb-4" id="close-update-btn">
                      ë‹«ê¸°
                    </button>
                  </p>
                </div>

                <div class="mb-3" id="delete-comment-box" style="display: none">
                  <hr/>
                  <div id="delete-comment-alert"></div>
                  <p class="mb-1" style="display: flex; justify-content: space-between;">
                    <label for="exampleInputPassword1" class="form-label">Password</label>
                    <button class="btn btn-secondary" id="delete-comment-btn"
                      style="--bs-btn-padding-y: .25rem; --bs-btn-padding-x: .5rem; --bs-btn-font-size: .75rem;">
                      ì‚­ì œí•˜ê¸°
                    </button>
                  </p>
                  <input id="delete-pw" type="password" class="form-control"/>
                </div>
              </div>

            </div>
            `;
        $("#comment-area").append(temp_html);
      });
      let count_html = `<div>${docs.size}ê°œì˜ ëŒ“ê¸€</div>`;
      $("#count").append(count_html);

      // ëŒ“ê¸€ ì‚­ì œ
      $("#comment-area").on("click", "#delete-comment-btn", async function () {
        const parent = $(this).closest("#delete-comment-box");
        const delete_alert = parent.find("#delete-comment-alert");
        const delete_pw = parent.find("#delete-pw").val();
        const created_date = Number(
          $(this).closest("#high").find("#hide-date").text()
        );

        // ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ ë°©ì§€
        delete_alert.empty();
        if (!delete_pw) {
          let delete_alert_html = `
            <div class="alert alert-warning" role="alert">
              ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
            </div>`;
          delete_alert.append(delete_alert_html);
          return;
        }

        // ë¹„ë²ˆ ë§ìœ¼ë©´ - ëŒ“ê¸€ì‚­ì œ
        let finddoc = await getDocs(
          query(
            collection(db, "comment2"),
            where("password", "==", delete_pw),
            where("createdAt", "==", created_date)
          )
        );
        finddoc.forEach(async (find) => {
          await deleteDoc(doc(db, "comment2", find.id));
          alert("ì‚­ì œ ì™„ë£Œ!");
          window.location.reload();
          return;
        });
        if (finddoc.empty) {
          // ë¹„ë²ˆ í‹€ë¦¬ë©´ ê²½ê³ 
          let alert_html = `
          <div class="alert alert-danger" role="alert">
            ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.
          </div>`;
          delete_alert.append(alert_html);
        }
      });

      let update_cm_pw = "";
      //ëŒ“ê¸€ ìˆ˜ì • : ìˆ˜ì •ì¹¸ ì ‘ê·¼
      $("#comment-area").on("click", "#update-pw-btn", async function () {
        const parent = $(this).closest("#update-pw-box");
        const update_alert = parent.find("#update-pw-alert");
        update_cm_pw = parent.find("#update-pw").val();
        const created_date = Number(
          $(this).closest("#high").find("#hide-date").text()
        );

        // ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ ë°©ì§€
        update_alert.empty();
        if (!update_cm_pw) {
          let alert_html = `
            <div class="alert alert-warning" role="alert">
              ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
            </div>`;
          update_alert.append(alert_html);
          return;
        }

        // ë¹„ë²ˆ ë§ìœ¼ë©´ - ìˆ˜ì •í•˜ê¸° ì¹¸ ìƒì„±
        let finddoc = await getDocs(
          query(
            collection(db, "comment2"),
            where("password", "==", update_cm_pw),
            where("createdAt", "==", created_date)
          )
        );
        // ë¹„ë²ˆ í‹€ë¦¬ë©´ ê²½ê³ 
        if (finddoc.empty) {
          let alert_html = `
          <div class="alert alert-danger" role="alert">
            ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤.
          </div>`;
          update_alert.append(alert_html);
          return;
        } else {
          const editSection = $(this)
            .closest("#high")
            .find("#update-comment-box");
          editSection.show();
          parent.find("#update-pw").val("");
          parent.hide();
          $(this).closest("#edit-buttons").find("#update-btn").text("ìˆ˜ì •í•˜ê¸°");
        }
      });

      // ìˆ˜ì • ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ
      $("#comment-area").on("click", "#update-comment-btn", async function () {
        const parent = $(this).closest("#update-comment-box");
        const update_comment_alert = parent.find("#update-comment-alert");
        const update_comment = parent.find("#update-comment").val();
        const created_date = Number(
          $(this).closest("#high").find("#hide-date").text()
        );

        // ë‚´ìš© ë¯¸ì…ë ¥ ë°©ì§€
        if (!update_comment) {
          let alert_html = `
            <div class="alert alert-warning" role="alert">
              ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”
            </div>`;
          update_comment_alert.append(alert_html);
          return;
        }

        let finddoc = await getDocs(
          query(
            collection(db, "comment2"),
            where("password", "==", update_cm_pw),
            where("createdAt", "==", created_date)
          )
        );
        finddoc.forEach(async (find) => {
          await updateDoc(doc(db, "comment2", find.id), {
            comment: update_comment,
            createdAt: Date.now(),
          });
          alert("ìˆ˜ì • ì™„ë£Œ!");
          window.location.reload();
        });
      });
    </script>
  </head>

  <body class="bg-light">
    <header class="header_section">
      <ul
        class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-left mb-md-0"
      >
        <li><a href="#" class="nav-link header_name">V8</a></li>
        <li><a href="mainscreen.html" class="nav-link person-name">í™ˆ</a></li>
        <li><a href="member1.html" class="nav-link person-name">ì°¨ì¤€í˜¸</a></li>
        <li><a href="member3.html" class="nav-link person-name">ë¥˜ìˆ˜ì—°</a></li>
        <li><a href="member4.html" class="nav-link person-name">ê¹€ë„ì—°</a></li>
        <li><a href="member5.html" class="nav-link person-name">ê³½í˜¸ë¯¼</a></li>
      </ul>
    </header>

    <main class="container my-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow rounded-3">
            <div class="row g-0">
              <div class="col-md-4">
                <img
                  src="image/ì´ì§„í¬.png"
                  class="person_image"
                  alt="ì´ì§„í¬ ì‚¬ì§„"
                />
              </div>
              <div class="col-md-8">
                <div class="card-body">
                  <h4 class="card-title fw-bold">ì´ì§„í¬</h4>
                  <span class="badge text-bg-success">íŒ€ì›</span>
                  <p class="card-text">ë§ì´ ë°°ì›Œê°€ê² ìŠµë‹ˆë‹¤!</p>
                  <ul class="list-unstyled">
                    <li><strong>ìƒì¼:</strong> 2000.01.13</li>
                    <li><strong>MBTI:</strong> ISTP</li>
                    <li>
                      <strong>ë¸”ë¡œê·¸ ì£¼ì†Œ:</strong>
                      <a href="https://genie0113.tistory.com/" target="_blank"
                        >https://genie0113.tistory.com/</a
                      >
                    </li>
                    <li>
                      <strong>TMI:</strong> í¬ë ˆìŠ¤í‹°ë“œ ê²Œì½” ë‘ë§ˆë¦¬ ì§‘ì‚¬ ğŸ¦
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
          <section class="mt-5">
            <div class="comment-top">
              <h5 class="comment">ëŒ“ê¸€</h5>
              <div id="count"></div>
            </div>
            <button class="btn btn-outline-primary mb-4" id="openclose">
              ëŒ“ê¸€ì‘ì„±í•˜ê¸°
            </button>
            <div id="commentbox" style="display: none">
              <div id="alert"></div>
              <div class="mb-3">
                <label for="commentName" class="name">ì´ë¦„</label>
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                />
              </div>
              <div class="mb-3">
                <label for="commentContent" class="content">ë‚´ìš©</label>
                <textarea
                  class="form-control"
                  id="comment"
                  rows="3"
                  placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="exampleInputPassword1" class="form-label"
                  >Password</label
                >
                <input type="password" class="form-control" id="password" />
              </div>
              <button class="btn btn-outline-primary mb-4" id="makeComment">
                ëŒ“ê¸€ì‘ì„±
              </button>
            </div>

            <div id="comment-area"></div>
          </section>
        </div>
      </div>
    </main>
  </body>
</html>
